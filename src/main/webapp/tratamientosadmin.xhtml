<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:comp="http://xmlns.jcp.org/jsf/composite/components">

<h:head>
    <title>Gestión de Tratamientos - Clínica Sonrisa Sana</title>
    <h:outputStylesheet library="css" name="common-styles.css"/>
    <h:outputStylesheet library="css" name="sidebar-styles.css"/>

    <style>
        .table-header {
            margin-bottom: 1.5rem;
        }

        .p-datatable .p-datatable-thead > tr > th {
            background: linear-gradient(135deg, #1976d2, #2196f3) !important;
            color: white !important;
            font-weight: 600;
        }

        .p-datatable .p-datatable-tbody > tr:hover {
            background: #e3f2fd !important;
        }
    </style>
</h:head>

<h:body>
    <div class="dashboard-container">

        <!-- SIDEBAR COMPONENT -->
        <comp:sidebar activePage="tratamientos"/>

        <!-- MAIN CONTENT -->
        <div class="main-content">

            <!-- TOP BAR -->
            <div class="top-bar">
                <h1>
                    <i class="pi pi-briefcase"></i>
                    Gestión de Tratamientos Odontológicos
                </h1>
            </div>

            <!-- CONTENT AREA -->
            <div class="content-area">

                <h:form id="frmTratamientos">

                    <!-- Mensajes del sistema -->
                    <p:messages id="msgTratamiento" showDetail="true" closable="true" />

                    <!-- Barra de herramientas -->
                    <div class="table-header">
                        <p:commandButton value="Nuevo Tratamiento"
                                         icon="pi pi-plus"
                                         styleClass="p-button-success"
                                         actionListener="#{tratamientoBean.limpiar}"
                                         update=":formDialog"
                                         oncomplete="PF('dlgTratamiento').show();" />

                        <p:commandButton value="Actualizar Tabla"
                                         icon="pi pi-refresh"
                                         styleClass="p-button-info"
                                         update="tblTratamientos"
                                         actionListener="#{tratamientoBean.cargarLista}"
                                         style="margin-left: 0.5rem;" />
                    </div>

                    <!-- Tabla de tratamientos -->
                    <p:dataTable id="tblTratamientos"
                                 value="#{tratamientoBean.lista}"
                                 var="t"
                                 paginator="true"
                                 rows="10"
                                 rowsPerPageTemplate="5,10,15,20"
                                 paginatorPosition="bottom"
                                 paginatorTemplate="{FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                 currentPageReportTemplate="Mostrando {startRecord} a {endRecord} de {totalRecords} tratamientos"
                                 styleClass="p-datatable-striped"
                                 emptyMessage="No hay tratamientos registrados">

                        <p:column headerText="ID" sortBy="#{t.id}" style="width:70px; text-align:center;">
                            <h:outputText value="#{t.id}" />
                        </p:column>

                        <p:column headerText="Nombre" sortBy="#{t.nombre}" filterBy="#{t.nombre}"
                                  filterMatchMode="contains" style="min-width:150px;">
                            <h:outputText value="#{t.nombre}" style="font-weight: 600;" />
                        </p:column>

                        <p:column headerText="Descripción" style="min-width:200px;">
                            <h:outputText value="#{t.descripcion.length() > 60 ? t.descripcion.substring(0, 60).concat('...') : t.descripcion}"
                                          title="#{t.descripcion}" />
                        </p:column>

                        <p:column headerText="Duración" sortBy="#{t.duracion}" style="width:120px; text-align:center;">
                            <h:outputText value="#{t.duracionFormateada}" />
                        </p:column>

                        <p:column headerText="Costo" sortBy="#{t.costo}" style="width:140px; text-align:right;">
                            <h:outputText value="#{t.costoFormateado}" style="font-weight: 600; color: #2ecc71;" />
                        </p:column>

                        <p:column headerText="Especialidad" sortBy="#{t.especialidad}"
                                  filterBy="#{t.especialidad}" filterMatchMode="equals" style="width:180px;">
                            <f:facet name="filter">
                                <p:selectOneMenu onchange="PF('tblTratamientos').filter()"
                                                 styleClass="p-column-filter" style="width: 100%;">
                                    <f:selectItem itemLabel="Todas" itemValue="#{null}" noSelectionOption="true" />
                                    <f:selectItems value="#{tratamientoBean.especialidades}" />
                                </p:selectOneMenu>
                            </f:facet>
                            <p:tag value="#{t.especialidad}" severity="info" />
                        </p:column>

                        <p:column headerText="Odontólogo" filterBy="#{t.nombreOdontologo}"
                                  filterMatchMode="contains" style="min-width:180px;">
                            <h:outputText value="#{t.nombreOdontologo}" />
                        </p:column>

                        <p:column headerText="Acciones" style="width:160px; text-align:center;">
                            <p:commandButton icon="pi pi-pencil"
                                             title="Editar tratamiento"
                                             styleClass="p-button-warning p-button-sm"
                                             actionListener="#{tratamientoBean.editar(t)}"
                                             update=":formDialog"
                                             oncomplete="PF('dlgTratamiento').show();"
                                             style="margin-right: 0.5rem;">
                                <p:resetInput target=":formDialog" />
                            </p:commandButton>

                            <!-- ✅ CORRECCIÓN: Ruta completa al mensaje -->
                            <p:commandButton icon="pi pi-trash"
                                             title="Eliminar permanentemente"
                                             styleClass="p-button-danger p-button-sm"
                                             actionListener="#{tratamientoBean.eliminar(t.id)}"
                                             update="tblTratamientos :frmTratamientos:msgTratamiento">
                                <p:confirm header="Confirmación"
                                           message="¿Está seguro de eliminar el tratamiento '#{t.nombre}'? Esta acción no se puede deshacer."
                                           icon="pi pi-exclamation-triangle" />
                            </p:commandButton>
                        </p:column>

                    </p:dataTable>

                </h:form>

                <!-- DIÁLOGO -->
                <p:dialog widgetVar="dlgTratamiento"
                          header="#{tratamientoBean.tratamiento.id == null ? 'Nuevo Tratamiento' : 'Editar Tratamiento'}"
                          modal="true"
                          width="700"
                          responsive="true"
                          closable="true"
                          resizable="false"
                          closeOnEscape="true">

                    <h:form id="formDialog">

                        <p:messages id="msgDialog" closable="true" />

                        <div style="padding: 1rem;">

                            <p:panelGrid columns="2" layout="grid" styleClass="p-fluid"
                                         columnClasses="p-col-12 p-md-4,p-col-12 p-md-8">

                                <p:outputLabel value="Nombre:" for="nombre" indicateRequired="true" />
                                <p:inputText id="nombre"
                                             value="#{tratamientoBean.tratamiento.nombre}"
                                             required="true"
                                             requiredMessage="El nombre del tratamiento es obligatorio"
                                             maxlength="100"
                                             placeholder="Ej: Limpieza Dental, Ortodoncia, etc." />

                                <p:outputLabel value="Descripción:" for="descripcion" indicateRequired="true" />
                                <div>
                                    <p:inputTextarea id="descripcion"
                                                     value="#{tratamientoBean.tratamiento.descripcion}"
                                                     rows="4"
                                                     required="true"
                                                     requiredMessage="La descripción es obligatoria"
                                                     maxlength="500"
                                                     counter="contador"
                                                     counterTemplate="{0} caracteres restantes"
                                                     placeholder="Describa el tratamiento detalladamente..." />
                                    <h:outputText id="contador" style="font-size: 0.875rem; color: #666; display: block; margin-top: 0.5rem;" />
                                </div>

                                <p:outputLabel value="Duración (min):" for="duracion" indicateRequired="true" />
                                <p:inputNumber id="duracion"
                                               value="#{tratamientoBean.tratamiento.duracion}"
                                               required="true"
                                               requiredMessage="La duración es obligatoria"
                                               minValue="1"
                                               maxValue="600"
                                               decimalPlaces="0"
                                               placeholder="Ej: 45"
                                               suffix=" minutos" />

                                <p:outputLabel value="Costo (Q):" for="costo" indicateRequired="true" />
                                <p:inputNumber id="costo"
                                               value="#{tratamientoBean.tratamiento.costo}"
                                               required="true"
                                               requiredMessage="El costo es obligatorio"
                                               minValue="0"
                                               mode="decimal"
                                               minFractionDigits="2"
                                               maxFractionDigits="2"
                                               placeholder="0.00"
                                               prefix="Q " />

                                <p:outputLabel value="Especialidad:" for="especialidad" indicateRequired="true" />
                                <p:selectOneMenu id="especialidad"
                                                 value="#{tratamientoBean.tratamiento.especialidad}"
                                                 required="true"
                                                 requiredMessage="La especialidad es obligatoria"
                                                 filter="true"
                                                 filterMatchMode="contains">
                                    <f:selectItem itemLabel="Seleccione una especialidad"
                                                  itemValue="#{null}"
                                                  noSelectionOption="true" />
                                    <f:selectItems value="#{tratamientoBean.especialidades}"
                                                   var="esp"
                                                   itemLabel="#{esp.toString().replace('_', ' ')}"
                                                   itemValue="#{esp}" />
                                </p:selectOneMenu>

                                <p:outputLabel value="Odontólogo:" for="odontologo" indicateRequired="true" />
                                <p:selectOneMenu id="odontologo"
                                                 value="#{tratamientoBean.tratamiento.odontologo}"
                                                 required="true"
                                                 requiredMessage="Debe seleccionar un odontólogo"
                                                 filter="true"
                                                 filterMatchMode="contains"
                                                 converter="odontologoConverter">
                                    <f:selectItem itemLabel="Seleccione un odontólogo"
                                                  itemValue="#{null}"
                                                  noSelectionOption="true" />
                                    <f:selectItems value="#{tratamientoBean.odontologos}"
                                                   var="odon"
                                                   itemLabel="#{odon.nombreCompleto}"
                                                   itemValue="#{odon}" />
                                </p:selectOneMenu>

                            </p:panelGrid>

                        </div>

                        <p:separator />

                        <div style="text-align: right; padding: 1rem;">
                            <p:commandButton value="Cancelar"
                                             styleClass="p-button-secondary"
                                             icon="pi pi-times"
                                             onclick="PF('dlgTratamiento').hide(); return false;"
                                             style="margin-right: 0.5rem;" />

                            <!-- ✅ CORRECCIÓN: Ruta completa al mensaje -->
                            <p:commandButton value="Guardar"
                                             icon="pi pi-save"
                                             styleClass="p-button-success"
                                             actionListener="#{tratamientoBean.guardar}"
                                             update="formDialog :frmTratamientos:tblTratamientos :frmTratamientos:msgTratamiento"
                                             oncomplete="if (!args.validationFailed) PF('dlgTratamiento').hide();" />
                        </div>

                    </h:form>

                </p:dialog>

                <!-- Diálogo de confirmación global -->
                <p:confirmDialog global="true"
                                 showEffect="fade"
                                 hideEffect="fade"
                                 responsive="true"
                                 width="400"
                                 severity="warn">
                    <p:commandButton value="Sí, eliminar"
                                     type="button"
                                     styleClass="p-button-danger ui-confirmdialog-yes"
                                     icon="pi pi-check" />
                    <p:commandButton value="Cancelar"
                                     type="button"
                                     styleClass="p-button-secondary ui-confirmdialog-no"
                                     icon="pi pi-times" />
                </p:confirmDialog>

            </div>
        </div>
    </div>

</h:body>
</html>