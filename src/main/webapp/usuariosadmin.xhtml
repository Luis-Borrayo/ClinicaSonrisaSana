<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:comp="http://xmlns.jcp.org/jsf/composite/components">

<h:head>
    <title>Gestión de Usuarios - Sonrisa Sana</title>
    <h:outputStylesheet library="css" name="commonadmin-styles.css"/>
    <h:outputStylesheet library="css" name="sidebaradmin-styles.css"/>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            margin-left: 260px; /* Ancho de la sidebar */
            padding: 2rem;
            min-height: 100vh;
            width: calc(100% - 260px);
        }

        .top-bar {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .top-bar h1 {
            color: #1976d2;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .content-area {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        /* Buttons */
        .p-button-success {
            background: linear-gradient(135deg, #1976d2, #2196f3) !important;
            border: none !important;
        }

        .p-button-success:hover {
            background: linear-gradient(135deg, #1565c0, #1976d2) !important;
        }

        .p-button-warning {
            background: linear-gradient(135deg, #ff9800, #fb8c00) !important;
            border: none !important;
        }

        .p-button-danger {
            background: linear-gradient(135deg, #f44336, #e53935) !important;
            border: none !important;
        }

        .p-button-secondary {
            background: linear-gradient(135deg, #757575, #616161) !important;
            border: none !important;
        }

        /* Table */
        .p-datatable .p-datatable-thead > tr > th {
            background: linear-gradient(135deg, #1976d2, #2196f3) !important;
            color: white !important;
            font-weight: 600;
        }

        .p-datatable .p-datatable-tbody > tr:hover {
            background: #e3f2fd !important;
        }

        /* Dialog */
        .p-dialog .p-dialog-header {
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
        }

        .p-dialog .p-dialog-content {
            padding: 2rem;
        }

        /* Status Badge */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }
        }
    </style>
</h:head>

<h:body>
    <div class="dashboard-container">

        <!-- ✅ SIDEBAR ADMIN COMPONENT -->
        <comp:sidebaradmin activePage="usuarios"/>

        <!-- MAIN CONTENT -->
        <div class="main-content">

            <!-- TOP BAR -->
            <div class="top-bar">
                <h1>
                    <i class="pi pi-users"></i>
                    Gestión de Usuarios
                </h1>
                <p style="color: #666;">Administra las cuentas de usuario del sistema</p>
            </div>

            <!-- CONTENT AREA -->
            <div class="content-area">

                <h:form id="frmUsers">

                    <!-- MESSAGES -->
                    <p:messages id="msgUser" closable="true" />

                    <!-- BOTÓN NUEVO -->
                    <p:commandButton value="Nuevo Usuario"
                                     icon="pi pi-plus"
                                     styleClass="p-button-success"
                                     actionListener="#{userBean.newUser}"
                                     update=":dlgUserForm"
                                     oncomplete="PF('dlgUser').show();"
                                     style="margin-bottom: 1.5rem;" />

                    <!-- TABLA DE USUARIOS -->
                    <p:dataTable id="tblUsers"
                                 value="#{userBean.list}"
                                 var="u"
                                 paginator="true"
                                 rows="10"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                 rowsPerPageTemplate="5,10,15"
                                 currentPageReportTemplate="Mostrando {startRecord}-{endRecord} de {totalRecords}"
                                 emptyMessage="No hay usuarios registrados"
                                 styleClass="p-datatable-striped">

                        <p:column headerText="ID" style="width:70px; text-align: center;">
                            <h:outputText value="#{u.id}" />
                        </p:column>

                        <p:column headerText="Usuario" sortBy="#{u.usuario}">
                            <h:outputText value="#{u.usuario}" />
                        </p:column>

                        <p:column headerText="Nombre completo" sortBy="#{u.nombres}">
                            <h:outputText value="#{u.nombres} #{u.apellidos}" />
                        </p:column>

                        <p:column headerText="Correo" sortBy="#{u.correo}">
                            <h:outputText value="#{u.correo}" />
                        </p:column>

                        <p:column headerText="Rol" style="text-align: center;">
                            <p:tag value="#{u.role}"
                                   severity="#{u.role == 'ADMINISTRADOR' ? 'danger' : u.role == 'ODONTOLOGO' ? 'info' : 'warning'}" />
                        </p:column>

                        <p:column headerText="Estado" style="text-align: center;">
                            <span class="status-badge #{u.active ? 'status-active' : 'status-inactive'}">
                                #{u.active ? 'ACTIVO' : 'INACTIVO'}
                            </span>
                        </p:column>

                        <!-- ACCIONES -->
                        <p:column headerText="Acciones" style="text-align:center; width:200px;">
                            <div class="action-buttons">
                                <!-- EDITAR -->
                                <p:commandButton icon="pi pi-pencil"
                                                 styleClass="p-button-warning"
                                                 actionListener="#{userBean.edit(u)}"
                                                 update=":dlgUserForm"
                                                 oncomplete="PF('dlgUser').show();"
                                                 title="Editar usuario" />

                                <!-- ACTIVAR (solo si está inactivo) -->
                                <p:commandButton icon="pi pi-check-circle"
                                                 styleClass="p-button-success"
                                                 actionListener="#{userBean.activar(u)}"
                                                 update="frmUsers:tblUsers frmUsers:msgUser"
                                                 rendered="#{not u.active}"
                                                 title="Activar usuario" />

                                <!-- DESACTIVAR (solo si está activo) -->
                                <p:commandButton icon="pi pi-ban"
                                                 styleClass="p-button-secondary"
                                                 actionListener="#{userBean.desactivar(u)}"
                                                 update="frmUsers:tblUsers frmUsers:msgUser"
                                                 rendered="#{u.active}"
                                                 title="Desactivar usuario" />

                                <!-- ELIMINAR -->
                                <p:commandButton icon="pi pi-trash"
                                                 styleClass="p-button-danger"
                                                 actionListener="#{userBean.delete(u)}"
                                                 update="frmUsers"
                                                 onclick="return confirm('¿Eliminar usuario permanentemente?');"
                                                 title="Eliminar usuario" />
                            </div>
                        </p:column>
                    </p:dataTable>

                </h:form>

                <!-- DIALOGO PARA CREAR/EDITAR USUARIO -->
                <p:dialog id="dlgUser"
                          widgetVar="dlgUser"
                          header="Datos del Usuario"
                          modal="true"
                          responsive="true"
                          closable="true"
                          resizable="false"
                          width="600">

                    <h:form id="dlgUserForm">

                        <p:messages autoUpdate="true" />

                        <p:panelGrid columns="2"
                                     columnClasses="label,value"
                                     styleClass="p-fluid"
                                     style="width: 100%;">

                            <p:outputLabel value="Nombres:" for="nombres" />
                            <p:inputText id="nombres"
                                         value="#{userBean.selected.nombres}"
                                         required="true"
                                         requiredMessage="Los nombres son obligatorios" />

                            <p:outputLabel value="Apellidos:" for="apellidos" />
                            <p:inputText id="apellidos"
                                         value="#{userBean.selected.apellidos}"
                                         required="true"
                                         requiredMessage="Los apellidos son obligatorios" />

                            <p:outputLabel value="Correo:" for="correo" />
                            <p:inputText id="correo"
                                         value="#{userBean.selected.correo}"
                                         required="true"
                                         requiredMessage="El correo es obligatorio" />

                            <p:outputLabel value="Usuario:" for="usuario" />
                            <p:inputText id="usuario"
                                         value="#{userBean.selected.usuario}"
                                         required="true"
                                         requiredMessage="El nombre de usuario es obligatorio" />

                            <p:outputLabel value="Rol:" for="role" />
                            <p:selectOneMenu id="role"
                                             value="#{userBean.selected.role}"
                                             required="true"
                                             requiredMessage="Debe seleccionar un rol"
                                             style="width:100%;">
                                <f:selectItem itemLabel="-- Seleccione un rol --" itemValue="#{null}" noSelectionOption="true" />
                                <f:selectItems value="#{userBean.roles}"
                                               var="r"
                                               itemLabel="#{r}"
                                               itemValue="#{r}" />
                            </p:selectOneMenu>

                            <p:outputLabel value="Contraseña:" for="password" />
                            <p:password id="password"
                                        value="#{userBean.selected.password}"
                                        feedback="true"
                                        toggleMask="true"
                                        required="#{userBean.selected.id == null}"
                                        requiredMessage="La contraseña es obligatoria"
                                        placeholder="#{userBean.selected.id == null ? 'Ingrese contraseña' : 'Dejar vacío para no cambiar'}" />

                            <p:outputLabel value="Confirmar contraseña:" for="confirmPassword" />
                            <p:password id="confirmPassword"
                                        value="#{userBean.confirmPassword}"
                                        feedback="false"
                                        toggleMask="true"
                                        required="#{userBean.selected.id == null}"
                                        requiredMessage="Debe confirmar la contraseña" />

                        </p:panelGrid>

                        <p:separator style="margin: 1.5rem 0;" />

                        <!-- BOTONES DEL DIALOGO -->
                        <div style="text-align: center;">
                            <p:commandButton value="Guardar"
                                             icon="pi pi-save"
                                             actionListener="#{userBean.save}"
                                             update="dlgUserForm :frmUsers:tblUsers :frmUsers:msgUser"
                                             oncomplete="if (!args.validationFailed) PF('dlgUser').hide();"
                                             styleClass="p-button-success"
                                             style="margin-right: 10px;" />

                            <p:commandButton value="Cancelar"
                                             styleClass="p-button-secondary"
                                             icon="pi pi-times"
                                             onclick="PF('dlgUser').hide(); return false;" />
                        </div>

                    </h:form>

                </p:dialog>

            </div>
        </div>
    </div>

</h:body>
</html>